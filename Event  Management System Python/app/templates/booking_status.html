{% include 'header.html' %}

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">
              <i class="fas fa-info-circle"></i> Booking Status - #{{ booking.id }}
            </h3>
            <a href="{{ url_for('booking.view_booking_detail', booking_id=booking.id) }}" 
               class="btn btn-secondary btn-sm">
              <i class="fas fa-arrow-left"></i> Back to Details
            </a>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h5 class="text-primary">Booking Information</h5>
              <table class="table table-borderless">
                <tr>
                  <td><strong>Booking ID:</strong></td>
                  <td>#{{ booking.id }}</td>
                </tr>
                <tr>
                  <td><strong>Event Date:</strong></td>
                  <td>{{ booking.event_date.strftime('%B %d, %Y') }}</td>
                </tr>
                <tr>
                  <td><strong>Event Time:</strong></td>
                  <td>{{ booking.start_at }}</td>
                </tr>
                <tr>
                  <td><strong>Duration:</strong></td>
                  <td>{{ booking.max_total_hour }} hours</td>
                </tr>
                <tr>
                  <td><strong>Guests:</strong></td>
                  <td>{{ booking.no_of_guest }}</td>
                </tr>
                <tr>
                  <td><strong>Total Amount:</strong></td>
                  <td>â‚¹{{ booking.amount }}</td>
                </tr>
              </table>
            </div>
            
            <div class="col-md-6">
              <h5 class="text-primary">Status Information</h5>
              
              <!-- Booking Status -->
              <div class="card mb-3">
                <div class="card-header">
                  <h6 class="mb-0">
                    <i class="fas fa-calendar-check"></i> Booking Status
                  </h6>
                </div>
                <div class="card-body">
                  {% if booking.accept_status == 0 %}
                    <div class="alert alert-warning mb-0">
                      <i class="fas fa-clock"></i> <strong>Pending</strong>
                      <p class="mb-0 mt-2">Your booking is currently under review. We'll notify you once it's processed.</p>
                    </div>
                  {% elif booking.accept_status == 1 %}
                    <div class="alert alert-success mb-0">
                      <i class="fas fa-check-circle"></i> <strong>Accepted</strong>
                      <p class="mb-0 mt-2">Your booking has been confirmed! Your event is scheduled.</p>
                    </div>
                  {% else %}
                    <div class="alert alert-danger mb-0">
                      <i class="fas fa-times-circle"></i> <strong>Rejected</strong>
                      <p class="mb-0 mt-2">Unfortunately, your booking could not be confirmed. Please contact us for more information.</p>
                    </div>
                  {% endif %}
                </div>
              </div>
              
              <!-- Payment Status -->
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">
                    <i class="fas fa-credit-card"></i> Payment Status
                  </h6>
                </div>
                <div class="card-body">
                  {% if booking.payment_status == 0 %}
                    <div class="alert alert-warning mb-0">
                      <i class="fas fa-clock"></i> <strong>Payment Pending</strong>
                      <p class="mb-0 mt-2">Payment is required to confirm your booking.</p>
                      <button id="rzp-pay-btn" class="btn btn-primary btn-sm mt-2" data-booking-id="{{ booking.id }}">
                        <i class="fas fa-credit-card"></i> Make Payment
                      </button>
                      <a href="{{ url_for('receipt.download_receipt', booking_id=booking.id) }}" class="btn btn-outline-secondary btn-sm mt-2">
                        <i class="fas fa-file-download"></i> Download Proforma Receipt (PDF)
                      </a>
                    </div>
                  {% elif booking.payment_status == 1 %}
                      <div class="alert alert-success mb-0">
                      <i class="fas fa-check-circle"></i> <strong>Payment Received</strong>
                      <p class="mb-0 mt-2">Payment has been successfully processed.</p>
                        <a href="{{ url_for('receipt.download_receipt', booking_id=booking.id) }}" class="btn btn-outline-secondary btn-sm mt-2">
                          <i class="fas fa-file-download"></i> Download Receipt (PDF)
                        </a>
                    </div>
                  {% else %}
                    <div class="alert alert-danger mb-0">
                      <i class="fas fa-times-circle"></i> <strong>Payment Failed</strong>
                      <p class="mb-0 mt-2">There was an issue with your payment. Please try again.</p>
                      <button id="rzp-pay-btn" class="btn btn-primary btn-sm mt-2" data-booking-id="{{ booking.id }}">
                        <i class="fas fa-credit-card"></i> Retry Payment
                      </button>
                      <a href="{{ url_for('receipt.download_receipt', booking_id=booking.id) }}" class="btn btn-outline-secondary btn-sm mt-2">
                        <i class="fas fa-file-download"></i> Download Proforma Receipt (PDF)
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <hr>
          
          <!-- Timeline -->
          <div class="row">
            <div class="col-md-12">
              <h5 class="text-primary">Booking Timeline</h5>
              <div class="timeline">
                <div class="timeline-item">
                  <div class="timeline-marker bg-primary">
                    <i class="fas fa-calendar-plus text-white"></i>
                  </div>
                  <div class="timeline-content">
                    <h6>Booking Created</h6>
                    <p class="text-muted">{{ booking.current_date }}</p>
                    <p>Your booking request was submitted successfully.</p>
                  </div>
                </div>
                
                {% if booking.accept_status == 1 %}
                  <div class="timeline-item">
                    <div class="timeline-marker bg-success">
                      <i class="fas fa-check text-white"></i>
                    </div>
                    <div class="timeline-content">
                      <h6>Booking Confirmed</h6>
                      <p class="text-muted">Confirmed</p>
                      <p>Your booking has been accepted and confirmed.</p>
                    </div>
                  </div>
                {% elif booking.accept_status == 2 %}
                  <div class="timeline-item">
                    <div class="timeline-marker bg-danger">
                      <i class="fas fa-times text-white"></i>
                    </div>
                    <div class="timeline-content">
                      <h6>Booking Rejected</h6>
                      <p class="text-muted">Rejected</p>
                      <p>Your booking could not be confirmed.</p>
                    </div>
                  </div>
                {% else %}
                  <div class="timeline-item">
                    <div class="timeline-marker bg-warning">
                      <i class="fas fa-clock text-white"></i>
                    </div>
                    <div class="timeline-content">
                      <h6>Under Review</h6>
                      <p class="text-muted">Pending</p>
                      <p>Your booking is currently being reviewed by our team.</p>
                    </div>
                  </div>
                {% endif %}
                
                {% if booking.payment_status == 1 %}
                  <div class="timeline-item">
                    <div class="timeline-marker bg-success">
                      <i class="fas fa-credit-card text-white"></i>
                    </div>
                    <div class="timeline-content">
                      <h6>Payment Completed</h6>
                      <p class="text-muted">Paid</p>
                      <p>Payment has been successfully processed.</p>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Contact Information -->
          <hr>
          <div class="row">
            <div class="col-md-12">
              <h5 class="text-primary">Need Help?</h5>
              <div class="alert alert-info">
                <i class="fas fa-phone"></i> <strong>Contact Support:</strong><br>
                <p class="mb-1">ðŸ“ž Phone: +1 (555) 123-4567</p>
                <p class="mb-1">ðŸ“§ Email: support@eventmanagement.com</p>
                <p class="mb-0">ðŸ’¬ Live Chat: Available 24/7</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.timeline {
  position: relative;
  padding-left: 30px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 15px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #e9ecef;
}

.timeline-item {
  position: relative;
  margin-bottom: 30px;
}

.timeline-marker {
  position: absolute;
  left: -22px;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1;
}

.timeline-content {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 5px;
  margin-left: 20px;
}

.timeline-content h6 {
  margin-bottom: 5px;
  color: #495057;
}

.timeline-content p {
  margin-bottom: 5px;
}
</style>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  async function createOrder(bookingId) {
    const response = await fetch(`/payment/create-order/${bookingId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      alert(err.error || 'Failed to create order');
      throw new Error('Order creation failed');
    }
    return response.json();
  }

  async function startPayment(bookingId) {
    try {
      const data = await createOrder(bookingId);
      const options = {
        key: data.key_id,
        amount: data.amount,
        currency: data.currency,
        name: 'Event Management',
        description: `Booking #${data.booking_id}`,
        order_id: data.order_id,
        prefill: {
          name: data.user?.name || '',
          email: data.user?.email || '',
          contact: data.user?.contact || ''
        },
        notes: { booking_id: String(data.booking_id) },
        handler: function (response){
          // Submit to server for verification
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/payment/verify';

          const addField = (name, value) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
          };

          addField('razorpay_payment_id', response.razorpay_payment_id);
          addField('razorpay_order_id', response.razorpay_order_id);
          addField('razorpay_signature', response.razorpay_signature);
          addField('booking_id', data.booking_id);

          document.body.appendChild(form);
          form.submit();
        },
        theme: { color: '#3399cc' }
      };
      const rzp = new Razorpay(options);
      rzp.on('payment.failed', function () {
        alert('Payment failed. Please try again.');
      });
      rzp.open();
    } catch (e) {
      console.error(e);
    }
  }

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('#rzp-pay-btn');
    if (btn) {
      const bookingId = btn.getAttribute('data-booking-id');
      startPayment(bookingId);
    }
  });
</script>

{% include 'footer.html' %} 